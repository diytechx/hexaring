<script>
  (function () {
    emailjs.init("19sxIv6OT-I-U0fGU");
  })();

  function getPackage() {
    const params = new URLSearchParams(window.location.search);
    return params.get("pkg");
  }

  function hasSentEmail() {
    return localStorage.getItem("ring_email_sent") === "true";
  }

  function markEmailSent() {
    localStorage.setItem("ring_email_sent", "true");
  }

  async function getIPInfo() {
    try {
      const res = await fetch("https://ipapi.co/json/");
      return await res.json();
    } catch (e) {
      return null;
    }
  }

  window.onload = async function () {
    const pkg = getPackage();

    let packageName = "Unknown Package";
    let redirectPage = "page1.html";

    if (pkg === "1") {
      packageName = "Package 1";
      redirectPage = "page1.html";
    } else if (pkg === "2") {
      packageName = "Package 2";
      redirectPage = "page2.html";
    }

    // ðŸ”’ CHECK ONE-TIME ONLY
    if (!hasSentEmail()) {
      const timestamp = new Date().toISOString();
      const ipInfo = await getIPInfo();

      const ip = ipInfo?.ip || "Unknown";
      const country = ipInfo?.country_name || "Unknown";
      const region = ipInfo?.region || "Unknown";
      const city = ipInfo?.city || "Unknown";
      const browser = navigator.userAgent;

      emailjs.send("service_fu9dcqi", "template_5jfm8nh", {
        package: packageName,
        ip_address: ip,
        country: country,
        region: region,
        city: city,
        browser: navigator.userAgent,
        timestamp: timestamp
      }).then(() => {
        markEmailSent();
      });
    }

    // redirect tetap jalan
    setTimeout(() => {
      window.location.href = redirectPage;
    }, 1200);
  };
</script>
