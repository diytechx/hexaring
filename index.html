<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <title>Loading...</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script>
    (function () {
      emailjs.init("19sxIv6OT-I-U0fGU"); // ganti dengan Public Key kau
    })();

    function getPackage() {
      const params = new URLSearchParams(window.location.search);
      return params.get("pkg");
    }

    function hasSentEmail() {
      return localStorage.getItem("ring_email_sent") === "true";
    }

    function markEmailSent() {
      localStorage.setItem("ring_email_sent", "true");
    }

    async function getIPInfo() {
      try {
        const res = await fetch("https://ipapi.co/json/");
        return await res.json();
      } catch (e) {
        return null;
      }
    }

    window.onload = async function () {
      const pkg = getPackage();

      let packageName = "Cincin NFC;
      let redirectPage = "page1.html";

      if (pkg === "1") {
        packageName = "Package 1";
        redirectPage = "page1.html";
      } else if (pkg === "2") {
        packageName = "Package 2";
        redirectPage = "page2.html";
      }

      // ðŸ”’ ONE-TIME EMAIL
      if (!hasSentEmail()) {
        markEmailSent(); // set terus supaya tak hantar lagi
        const timestamp = new Date().toISOString();
        const ipInfo = await getIPInfo();

        const ip = ipInfo?.ip || "Unknown";
        const country = ipInfo?.country_name || "Unknown";
        const region = ipInfo?.region || "Unknown";
        const city = ipInfo?.city || "Unknown";
        const browser = navigator.userAgent;

        emailjs.send("service_fu9dcqi", "template_5jfm8nh", {
          package: packageName,
          ip_address: ip,
          country: country,
          region: region,
          city: city,
          browser: browser,
          timestamp: timestamp
        }).catch(err => console.error("Email failed:", err));
      }

      // ðŸ”„ Redirect selalu jalan
      setTimeout(() => {
        window.location.href = redirectPage;
      }, 1200);
    };
  </script>

  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      text-align: center;
      padding-top: 120px;
    }
  </style>
</head>
<body>
  <p>Initializing HexaRing</p>
  <p>Secure handshake in progress</p>
</body>
</html>
